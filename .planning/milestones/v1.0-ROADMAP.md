# Milestone v1.0: Mindsmith Native API

**Status:** SHIPPED 2026-02-01
**Phases:** 1-6
**Total Plans:** 17

## Overview

Provider-agnostic LLM API layer for Mindsmith. Starting with unified types and translation, built up through API endpoints, session management, tier routing, tool calling, and documentation. OpenAI is the only provider wired for v1; Anthropic and xAI inform the design but are deferred to v2.

## Phases

### Phase 1: Types and Translation

**Goal**: Establish the canonical message format that all providers translate to/from
**Depends on**: Nothing (first phase)
**Plans**: 4 plans

Plans:
- [x] 01-01: Unified types definition
- [x] 01-02: OpenAI translator
- [x] 01-03: Streaming normalization
- [x] 01-04: Error handling and Anthropic translator scaffold

**Details:**
- Native types: Role, Content, ContentPart, Message with OpenAI-compatible serialization
- Untagged enum for content (text or parts), tagged enum for ContentPart by "type"
- deny_unknown_fields for strict request validation
- Streaming types with Delta, StreamChoice, StreamChunk

### Phase 2: API Endpoints

**Goal**: Expose /native/* endpoints that accept unified format and return responses
**Depends on**: Phase 1
**Plans**: 2 plans

Plans:
- [x] 02-01: Chat completions endpoint with streaming + non-streaming
- [x] 02-02: Integration tests and /v1/* regression verification

**Details:**
- POST /native/v1/chat/completions handler
- SSE streaming with content accumulation
- Non-streaming JSON response
- Existing /v1/* endpoints unchanged

### Phase 3: Session Management

**Goal**: Track conversations to ensure consistent provider selection within a session
**Depends on**: Phase 2
**Plans**: 2 plans

Plans:
- [x] 03-01: Session storage foundation (Session struct, SessionManager, config)
- [x] 03-02: Handler integration (AppState wiring, request field, tests)

**Details:**
- Session stored as JSON in Redis with activity-based TTL refresh
- 24-hour session expiration
- conversation_id field in request enables session tracking
- Session model overrides request model for stickiness

### Phase 4: Tier Routing

**Goal**: Map complexity tiers to specific models based on configuration from Zion
**Depends on**: Phase 3
**Plans**: 4 plans

Plans:
- [x] 04-01: Foundation types (Tier enum, config types, request field)
- [x] 04-01b: Zion integration (get_tier_config, TierConfigCache, caching)
- [x] 04-02: Selection (TierRouter, cost-weighted selection, health tracking)
- [x] 04-03: Integration (Handler wiring, session tier, observability, tests)

**Details:**
- Tier enum: simple | moderate | complex with ordering
- TierConfigCache with 30-minute TTL from Zion
- Cost-weighted probabilistic selection (weight = 1/relative_cost)
- ProviderHealthTracker with exponential backoff (30s initial, 5min max)
- 503 with Retry-After when all providers unavailable

### Phase 5: Tool Calling

**Goal**: Support function/tool calling through unified schema with provider translation
**Depends on**: Phase 4
**Plans**: 3 plans

Plans:
- [x] 05-01: Tool types and schema validation
- [x] 05-02: Request translation and tool call response handling
- [x] 05-03: Streaming tool calls and integration tests

**Details:**
- ToolDefinition, ToolCall, ToolResult, ToolChoice types
- JSON Schema validation for tool parameters
- Arguments as parsed JSON (serde_json::Value)
- ToolCallAccumulator for streaming with index-based ordering
- call_{uuid} ID format for Sentinel-generated IDs

### Phase 6: Documentation

**Goal**: Provide OpenAPI specification for the Native API with protected access
**Depends on**: Phase 5
**Plans**: 2 plans

Plans:
- [x] 06-01: OpenAPI spec generation with utoipa
- [x] 06-02: Docs endpoint with API key protection

**Details:**
- utoipa 5.4 with ToSchema derives on all native types
- OpenAPI 3.1.0 specification with realistic examples
- CDN-hosted Swagger UI at /native/docs
- Dedicated API key protection (not JWT)
- 404 on unauthorized (hide endpoint existence)

---

## Milestone Summary

**Key Decisions:**
- Tier-based model selection abstracts provider details from client
- Session stickiness ensures consistent UX within conversations
- Full history per request keeps Sentinel stateless
- Errors bubble up (no silent failover) for client control
- Cost-weighted selection favors cheaper models
- deny_unknown_fields enforces strict API contract

**Issues Resolved:**
- Message format extensible to images without breaking changes
- Tool calling works with streaming (index-based accumulation)
- Provider health tracked per model with exponential backoff
- OpenAPI spec auto-generated from code

**Issues Deferred:**
- Anthropic provider implementation (v2)
- X/Grok provider implementation (v2)
- Vision/image support (v2)
- Structured output support (v2)

**Technical Debt Incurred:**
None â€” all implementations production-ready

---

*For current project status, see .planning/MILESTONES.md*
